# 维护手册

本文档面向系统管理员，涵盖日常维护、故障排查和配置管理。

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                     你的 Mac 电脑                            │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐ │
│  │  浏览器界面  │ ←→ │  Next.js    │ ←→ │  Python 后端     │ │
│  │  (聊天框)   │    │  前端服务    │    │  FastAPI        │ │
│  └─────────────┘    └─────────────┘    └────────┬────────┘ │
│                                                  │          │
│                         ┌────────────────────────┘          │
│                         ↓                                   │
│                  ┌─────────────┐                           │
│                  │  向量数据库  │  ← 存储文档的"语义索引"    │
│                  │   ChromaDB  │                           │
│                  └─────────────┘                           │
└─────────────────────────────────────────────────────────────┘
```

## 日常维护

### 启动系统

```bash
cd /Users/ngz/Desktop/Ai-Project/prompt-cto/frontend-rag-knowledge-base
./start.sh
```

### 停止系统

在启动脚本的终端按 `Ctrl + C`，或：

```bash
# 停止后端
lsof -ti:8000 | xargs kill -9

# 停止前端
lsof -ti:3001 | xargs kill -9
```

### 查看服务状态

```bash
# 检查端口占用
lsof -i:8000,3001

# 测试后端健康
curl http://localhost:8000/health

# 查看知识库统计
curl http://localhost:8000/api/stats
```

## 文档同步

### 手动同步官方文档

```bash
# 同步所有官方文档
curl -X POST http://localhost:8000/api/sync \
  -H "Content-Type: application/json" \
  -d '{"source": "all"}'

# 只同步 React 文档
curl -X POST http://localhost:8000/api/sync \
  -H "Content-Type: application/json" \
  -d '{"source": "official"}'
```

### 配置 GitHub 同步

编辑 `backend/.env`：

```env
GITHUB_REPO=your-org/your-docs-repo
GITHUB_TOKEN=ghp_xxxxxxxxxxxx
```

获取 GitHub Token：
1. 访问 https://github.com/settings/tokens
2. 点击 "Generate new token"
3. 选择 `repo` 权限
4. 复制 Token 填入配置

### 上传本地文档

```bash
# 通过 API 上传
curl -X POST http://localhost:8000/api/upload \
  -F "file=@/path/to/your/document.md" \
  -F "title=文档标题"
```

## 配置管理

### 核心配置文件

**`backend/.env`** - 环境变量配置

```env
# DeepSeek API（对话生成）
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxx

# Embedding 配置
EMBEDDING_PROVIDER=local  # 可选: openai, zhipu, local
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxx  # 使用 OpenAI 时需要

# GitHub 同步
GITHUB_REPO=org/repo
GITHUB_TOKEN=ghp_xxxxxxxx

# 服务配置
HOST=0.0.0.0
PORT=8000
```

**`backend/config.py`** - 系统配置

可调整的参数：

```python
# 文本分块大小（字符数）
CHUNK_SIZE = 1000
CHUNK_OVERLAP = 200

# 检索配置
TOP_K = 5  # 每次检索返回的文档数
SIMILARITY_THRESHOLD = 0.1  # 相似度阈值

# LLM 配置
LLM_TEMPERATURE = 0.3  # 创造性程度（0-1）
LLM_MAX_TOKENS = 2000  # 最大回答长度
```

### 官方文档源配置

编辑 `backend/config.py` 中的 `OFFICIAL_SOURCES`：

```python
OFFICIAL_SOURCES = {
    "react": {
        "name": "React 官方文档",
        "base_url": "https://react.dev",
        "sitemap": "https://react.dev/sitemap.xml",
    },
    # 添加更多源...
}
```

## 故障排查

### 问题：Internal Server Error

**排查步骤：**

1. 检查后端是否运行
   ```bash
   curl http://localhost:8000/health
   ```

2. 查看后端日志
   ```bash
   # 如果是用 start.sh 启动的，查看终端输出
   # 或手动启动查看错误
   cd backend && venv/bin/python main.py
   ```

3. 常见原因：
   - API Key 配置错误
   - 依赖未安装完整
   - 端口被占用

### 问题：提问返回"找不到相关信息"

**排查步骤：**

1. 检查知识库是否为空
   ```bash
   curl http://localhost:8000/api/stats
   ```

2. 检查文档是否已同步
   ```bash
   curl http://localhost:8000/api/sources
   ```

3. 检查 Embedding 模型是否加载
   - 首次使用本地模型需要下载（约 100MB）
   - 查看后端日志是否有"模型加载完成"

4. 调整相似度阈值
   - 编辑 `backend/config.py`
   - 降低 `SIMILARITY_THRESHOLD` 值（如改为 0.05）

### 问题：同步文档失败

**排查步骤：**

1. 检查网络连接
   ```bash
   curl -I https://react.dev
   ```

2. 检查 GitHub Token 权限
   ```bash
   curl -H "Authorization: token YOUR_TOKEN" \
     https://api.github.com/repos/YOUR_ORG/YOUR_REPO
   ```

3. 查看详细错误日志
   - 后端日志会显示具体错误信息

### 问题：前端页面无法访问

**排查步骤：**

1. 检查前端是否运行
   ```bash
   lsof -i:3001
   ```

2. 重新安装前端依赖
   ```bash
   cd frontend
   rm -rf node_modules package-lock.json .next
   npm install
   npm run dev
   ```

3. 检查是否有语法错误
   ```bash
   npx tsc --noEmit
   ```

## 数据管理

### 备份知识库

```bash
# 备份向量数据库
cp -r backend/chroma_db ./chroma_db_backup_$(date +%Y%m%d)

# 备份上传的文档
cp -r backend/documents ./documents_backup_$(date +%Y%m%d)
```

### 清空知识库

```bash
# 停止后端后删除数据库
rm -rf backend/chroma_db
# 重启后会自动重建
```

### 查看数据库统计

```bash
cd backend
venv/bin/python -c "
from database import get_vector_store
store = get_vector_store()
print(f'总文档数: {store.collection.count()}')
print(f'来源列表: {store.list_sources()}')
"
```

## 性能优化

### 如果回答很慢

1. **使用 OpenAI Embedding**（替代本地模型）
   - 编辑 `.env`: `EMBEDDING_PROVIDER=openai`
   - 配置 `OPENAI_API_KEY`

2. **减少 TOP_K 值**
   - 编辑 `config.py`: `TOP_K = 3`

3. **减小 LLM 输出长度**
   - 编辑 `config.py`: `LLM_MAX_TOKENS = 1000`

### 如果内存占用太高

1. **使用 API 方案**（OpenAI/智谱）替代本地模型
2. **减小文本分块大小**
   - 编辑 `config.py`: `CHUNK_SIZE = 500`

## 安全注意事项

⚠️ **API Key 安全**
- 不要将 `.env` 文件提交到 Git
- 定期更换 API Keys
- 为 GitHub Token 设置最小权限

⚠️ **数据安全**
- 本地部署数据不会上传到云端
- 如果使用 OpenAI API，提问内容会发送到 OpenAI 服务器
- 敏感文档建议使用本地 Embedding 方案

## 更新系统

### 更新代码

```bash
git pull  # 如果有版本控制
# 或手动替换文件
```

### 更新依赖

```bash
# 后端
cd backend
source venv/bin/activate
pip install -r requirements.txt --upgrade

# 前端
cd frontend
npm update
```

## 获取帮助

- 查看 API 文档：http://localhost:8000/docs
- 查看后端日志（启动时的终端输出）
- 联系技术支持

## 常用命令速查

```bash
# 启动系统
./start.sh

# 停止系统
lsof -ti:8000,3001 | xargs kill -9

# 检查状态
curl http://localhost:8000/health
curl http://localhost:8000/api/stats

# 同步文档
curl -X POST http://localhost:8000/api/sync -H "Content-Type: application/json" -d '{"source":"all"}'

# 备份数据
cp -r backend/chroma_db ./backup_$(date +%Y%m%d)
```
